{% extends "bootstrap5/layout.html" %}
{% load static %}
{% load i18n %}
{% load l10n %}

{% comment "License" %}
* OSIS stands for Open Student Information System. It's an application
* designed to manage the core business of higher education institutions,
* such as universities, faculties, institutes and professional schools.
* The core business involves the administration of students, teachers,
* courses, programs and so on.
*
* Copyright (C) 2015-2019 Universit√© catholique de Louvain (http://www.uclouvain.be)
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* A copy of this license - GNU General Public License - is available
* at the root of the source code of this program.  If not,
* see http://www.gnu.org/licenses/.
{% endcomment %}
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'assistant_mandates' %}" id="lnk_my_mandates">{% trans 'My mandates' %}</a></li>
<li class="breadcrumb-item active">{% trans 'Renewal application form' %}</li>
{% endblock %}
{% block content %}
<ul class="nav nav-tabs ">
    <li class="nav-item"><a href="{% url 'assistant_mandates' %}" class="nav-link">{% trans 'My mandates' %}</a></li>
    <li class="nav-item"><a href="{% url 'form_part1_edit' %}" class="nav-link">{% trans 'Administrative' %}</a></li>
    <li class="nav-item"><a href="{% url 'mandate_learning_units' %}" class="nav-link">{% trans 'Learning units' %}</a></li>
    <li class="nav-item"><a href="{% url 'form_part3_edit' %}" class="nav-link">{% trans 'Ph.D.' %}</a></li>
    <li class="nav-item"><a href="{% url 'form_part4_edit' %}" class="nav-link active">{% trans 'Research' %}</a></li>
    <li class="nav-item"><a href="{% url 'form_part5_edit' %}" class="nav-link">{% trans 'Activities' %}</a></li>
    <li class="nav-item"><a href="{% url 'form_part6_edit' %}" class="nav-link">{% trans 'Summary' %}</a></li>
</ul>
<div class="card">
	<div class="card-body">
 		<form id="pst-form-part4" method="POST" enctype="multipart/form-data" action="{% url 'form_part4_save' %}">
 		{% csrf_token %}
 		{{ form.non_field_errors }}
 		<div class="card border-0">
            <div class="card-heading border-bottom">
                <h4 class="fs-5 my-2">{% trans 'Research' %}</h4>
    		</div>
    	</div>
    	<div class="form-group" style="padding-top: 10px">
      		<label for="internships">{% trans 'Scientific stay(s) and/or course(s)' %}</label>
            {{ form.internships }}
            <span class="error">{{ form.internships.errors }}</span>
      	</div>
      	<div class="form-group">
            <label for="conferences">{% trans 'Conference(s) to which I have contributed by communication or post, alone or with others.' %}</label>
            {{ form.conferences }}
            <span class="error">{{ form.conferences.errors }}</span>
      	</div>
      	<div class="form-group">
            <label for="publications">{% trans 'Publication(s) in preparation' %}</label>
            {{ form.publications }}
            <span class="error">{{ form.publications.errors }}</span>
      	</div>
      	<div class="form-group">
            <label for="awards">{% trans 'Prize(s) and/or distinction(s)' %}</label>
            {{ form.awards }}
            <span class="error">{{ form.awards.errors }}</span>
      	</div>
      	<div class="form-group">
            <label for="framing">{% trans 'Participation in thesis and/or dissertation' %}</label>
            {{ form.framing }}
            <span class="error">{{ form.framing.errors }}</span>
      	</div>
      	<div class="form-group">
            <label for="remark">{% trans 'Remark' %}</label>
            {{ form.remark }}
            <span class="error">{{ form.remark.errors }}</span>
      	</div>
          <div class="card border-0">
            <div class="card-heading border-bottom">
                <h4 class="fs-5 my-2">{% trans 'List of publications in PDF format (DIAL)' %}</h4>
    		</div>
    	</div>
        <div class="list-group">
            {% for file in files %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <a id="hdn_filename" href="{% url 'assistant_file_download' document_file_id=file.id %}" class="no_spinner">{{ file.document_file }}</a>
                <button type="button" class="btn btn-danger" id="btn_delete_file" onclick="location.href='{% url 'assistant_file_delete' file.id 'form_part4_edit' %}';">
                    <i class="fa fa-times"></i>
                    {% trans 'Delete' %}
                </button>
            </div>
            {% endfor %}
        </div>
        <div class="row mt-3 px-3">
            <a class="btn btn-default me-2" data-bs-toggle="modal" data-bs-target="#pnl_upload_documents"
               id="btn_add_file" title="{% trans 'Add file'%}">
                <i class="fas fa-arrow-circle-up" aria-hidden="true" id="spn_add_file"></i>
                {% trans 'Attach a PDF file' %}</a>
        </div>
        <hr>
	    <input type="hidden" value="{{mandate.id | default_if_none:''}}" id="hdn_current_mandate_id"
		   name="mandate_id" title="mandate_id" >
        <input type="hidden" value="{{ document_type }}" id="hdn_description" name="description" title="description">
        <button type="submit" class="btn btn-primary" title="{% trans 'Save'%}" id="bt_pstform_part3_save">
     	<i class="far fa-save" aria-hidden="true"></i> {% trans 'Save'%}</button>
    	</form>
	</div>
</div>
<!-- UploadFile modal -->
{% include "new_document.html" %}
{% endblock %}
{% block script %}
    <script>
        //***************************
        //File upload
        //***************************
        $("#txt_file").on("change", function(){
           var file = this.files[0];
           fileName = file.name;
           $("#hdn_filename").val(fileName);
           if(fileName.length > 100){
                document.getElementById('error_modal_upload_alert').classList.remove('d-none');
                document.getElementById("error_modal_upload").innerHTML = "{% trans 'The length of filename may not exceed 100 characters.'%}";
                $("#txt_file").val('')
                $('#pnl_upload_error').remove();
                event.preventDefault();
                event.stopImmediatePropagation();
                return false;
            }
            else {
                document.getElementById('error_modal_upload_alert').classList.add('d-none');
                document.getElementById("error_modal_upload").innerHTML = "";
            }
            res = /.*[()%$,;:/=+].*/i.test(fileName);
            if(res) {
                document.getElementById('error_modal_upload_alert').classList.remove('d-none');
                document.getElementById("error_modal_upload").innerHTML = "{% trans 'Filename can not contains : ( ) % $ , ; : / = +'%}";
                $("#txt_file").val('')
                $('#pnl_upload_error').remove();
                event.preventDefault();
                event.stopImmediatePropagation();
                return false;
            }
            else {
                document.getElementById('error_modal_upload_alert').classList.add('d-none');
                document.getElementById("error_modal_upload").innerHTML = "";
            }
        });
        $('[id^="bt_load_doc_"]').click(function(event) {
            var target = $(event.target);
            var id = target.attr("id");
            var pos = id.indexOf('bt_load_doc_');
            var description = id.substring(pos+12);
        });
        $("#bt_upload_document").click(function(event) {
            var target = $(event.target);
            var id = target.attr("id");
            var form = target.form;
            var description = $("#hdn_description").val();
            //Clear existing fields
            $('#hdn_file_' + $("#txt_file").val()).remove();
            $('#hdn_file_name_' + description).remove();
            $('#hdn_file_description_' + description).remove();
            var fileSelect = document.getElementById('txt_file');
            var files = fileSelect.files;
            var file = files[0];
            var data = new FormData();
            data.append('description', description);
            data.append('storage_duration', 0);
            data.append('content_type', file.type);
            data.append('filename', $("#txt_file").val());
            data.append('mandate_id', $("#hdn_current_mandate_id").val());
            var accepted_types = ['application/pdf'];
            if (file) {
                if ($.inArray(file.type, accepted_types) >= 0) {
                    data.append('file', file);
                    $.ajax({
                        url: "{% url 'assistant_file_upload' %}",
                        enctype: 'multipart/form-data',
                        type: 'POST',
                        data: data,
                        processData: false,
                        contentType: false,
                        complete: function(xhr, statusText) {
                            window.location.reload(true);
                        }
                    });
                    return true;
                }
                else {
                    document.getElementById('error_modal_upload_alert').classList.remove('d-none');
                    document.getElementById("error_modal_upload").innerHTML = "{% trans 'You must select a PDF file'%}";
                    $("#txt_file").val('')
                    $('#pnl_upload_error').remove();
                    event.preventDefault();
                    event.stopImmediatePropagation();
                    return false;
                }
            }
        });
        $("#pst-form-part4 :input").change(function() {
            $("#pst-form-part4").data("changed",true);
        });
        $('a').on('click', function(e) {
            if ($("#pst-form-part4").data("changed")) {
                var choice = confirm("{% trans 'Click OK to save the modified data before moving to another section.  Click Cancel to continue without saving.' %}");
                if (choice == true) {
                    e.preventDefault();
                    $('form#pst-form-part4').submit();
               }
            }
        });
    </script>
{% endblock %}
